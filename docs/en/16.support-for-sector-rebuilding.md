# Support for sector rebuilding

When the disk containing sector data is damaged or sector data is lost due to other reasons, sector data can be recovered through sector rebuilding.

## Basic principle

`damocles-manager` saves information about sector piece files and applied randomness etc. During sector rebuilding, `damocles-manager` will issue this information to `damocles-worker`, which then executes the sealing process. The general process is roughly: rebuild task state flow.

## Preparation

### 1. Prepare the sector number and miner ID that need rebuilding

### 2. Modify `damocles-worker` configuration

There are two ways to modify the configuration:

First: Modify the main configuration file of `damocles-worker`, add a sealing\_thread with plan set to rebuild, or change the plan of an existing sealing\_thread to rebuild. This requires restarting `damocles-worker`. Example:

```TOML
# /path/to/your-damocles-worker-config.toml

# ...
[[sealing_thread]]
location = "/path/to/your_sealing_thread_location/"
plan = "rebuild"
# ...
```

Second: Create a sealing\_thread hot update configuration file. Create a file named `config.toml` under the location directory of sealing\_thread. The file content is:

```TOML
# /path/to/your_sealing_thread_location/config.toml

plan = "rebuild"
```

`damocles-worker` will load the hot update configuration file before starting the sector task. See sealing\_thread configuration hot update for details.

### 3. Check sealing\_thread status

Execute:
```
damocles-worker worker list
```
output:
```
#0: "/path/to/your_sealing_thread_location"; plan=rebuild, sector_id=None, paused=false, paused_elapsed=None, state=Empty, last_err=None
// ...
```

Or execute:
```
damocles-manager util worker info  <worker instance name or address>
```
output:
```
Index  Loc                                    Plan     SectorID       Paused  PausedElapsed  State      LastErr
0      /path/to/your_sealing_thread_location  rebuild  NULL           false   NULL           Empty      NULL
// ...
```
If plan shows rebuild then the configuration change succeeded. (Note: hot update configuration file may not take effect immediately, it needs to wait for the sector task to restart to load it)

## Start rebuilding

### 1. Create sector rebuild task

Command:
```
damocles-manager util sealer sectors rebuild <miner actor> <sector number>
```
Where` \<miner actor\> `is the miner ID, `\<sector number\>` is the sector number to rebuild.

Let's take miner ID 1001, sector number 123 that need to rebuild as example. Execute:
```
damocles-manager util sealer sectors rebuild 1001 123
```

### 2. Observe the sealing state of the rebuild sealing\_thread, wait for rebuilding to complete

Execute:
```
damocles-worker worker list
```
or:
```
damocles-manager util worker info  <worker instance name or address>
```
Observe the state and last\_err field information. The state field corresponds to the state in [rebuild task state flow](./11.task-status-flow.md).

Or directly check sector status information:
```
// Query pending sectors
damocles-manager util sealer sectors state 1001 123

// Query sealed sectors
damocles-manager util sealer sectors state --offline 1001 123
```

## Other related commands

### Query information of all rebuilding sectors in progress
```
damocles-manager util sealer sectors list --rebuild --sealing=false
```

### Query information of all completed rebuilt sectors
```
damocles-manager util sealer sectors list --offline --rebuild --sealing=false
```