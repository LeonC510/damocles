## Support for Unseal Tasks

### Overview

Order retrieval is an important part of the Filecoin ecosystem loop. Currently, `Droplet` will default to using the `Piece data` in its `PieceStore` to respond to data requests from retrieval orders. At the same time, users can also configure `Droplet` to control the Piece data cached, so when Droplet finds that there is no data for the target Piece in the database, it will trigger an `unseal task` and issue the task to `Damocles`. After the `Damocles Manager` (hereinafter referred to as: `Manager`) receives this task, it will assign it to the `Damocles Worker` (hereinafter referred to as: `Worker`) that supports the `unseal plan`. After the `Worker` completes the task, it will upload the unsealed file to the location specified in the `unseal task` (this location is the PieceStore of the `Droplet` by default).

### Principles
 After the order is sealed, the `sealed file` will be left in the `permanent storage directory` to handle spacetime proofs and `unseal tasks`. After the `Woker` receives the `unseal task`, it will obtain the `sealed file` and `metadata` of the target Piece data sector from the `Manager`, and then execute the inverse algorithm of PC1 to restore the Piece data.

### Enabling

`Damocles` supporting `unseal tasks` just need to enable a `sealing process` that supports the `unseal plan` on the Worker. There are two ways to enable a `sealing process` that supports the `unseal plan`:

1. Directly modify the main configuration file of the `Worker`, add a new sealing process, or directly modify the `plan` of the existing sealing process. Restart at the appropriate time.

[[sealing\_thread]]

location = "./mock-tmp/store1"

plan = "unseal"

2. Use the `configuration hot update` method to add or modify the sealing process. See the Configuration Hot Update section for details.

### Manually triggering unseal tasks
 In some cases where Piece data is lost or some other special circumstances, we may want to manually trigger `unseal tasks` to obtain Piece data. At this point, we can use the command line tool provided by the `Manager` to manually generate and trigger `unseal tasks`.
```sh
damocles-manager util sealer sectors unseal
NAME:
   damocles-manager util sealer sectors unseal - unseal specified sector

USAGE:
   damocles-manager util sealer sectors unseal command [command options] <piece_cid>

COMMANDS:
   help, h  Shows a list of commands or help for one command

OPTIONS:
   --output value, -o value                        output piece as a car file to the specific path
   --actor value, --miner value, --actor-id value  specify actor id of miner manully, it must worke with flag "--sector"  (default: 0)
   --sector value, --sector-id value               specify sector number manully, it must worke with flag "--actor"  (default: 0)
   --piece-info-from-droplet, --from-droplet       get piece info from droplet, which come from damocles db by default . (default: false)
   --unseal-file value                             unseal piece from unseal file
   --offset value                                  specify offset of piece manually (default: 0)
   --size value                                    specify size of piece manually (default: 0)
   --dest value                                    specify destination to transfer piece manually, there are five protocols can be used:"file:///path","http://" "https://", "market://store_name/piece_cid", "store://store_name/piece_cid"
   --help, -h                                      show help (default: false)

```


#### Simple unseal piece Usage

Users can directly publish an `unseal task ` with the cid (piececid) of the piece data:

damocles-manager util sealer sectors unseal \<piece\_cid\>

At this point, the `Manager` will generate an `unseal task`. At this time, unseal task-related logs can be seen in the `Manager`, such as:

add new dest to unseal task

At this time, the program will continue to run until the unseal task is completed, and a file named the piece cid will be generated in the current directory.

#### Flag explanation

##### Specify different ways to get piece info

Restoring piece data requires obtaining the position and size of the piece data in the sector. The `unseal task` will default to obtaining the `offset` and `size` information of the piece data from the `Manager` database. But sometimes, when the data in the database is lost or incomplete, we may want to get these parameters from elsewhere or manually specify these two parameters. This is where the following three flags can come in handy:
```sh
   --from-droplet             get piece info from venus-market, which come from damocles db by default . (default: false)
   --offset value            specify offset of piece manually (default: 0)
   --size value              specify size of piece manually (default: 0)
```
- From-droplet get `offset` and `size` from `Droplet`, provided the Manager is already connected to Droplet.
- ffset: the position of the piece data in the sector
- size: the size of the Piece data

If you just upgraded to a version after v0.7.0, there may be incomplete data in the database (before v0.7.0, the database would not record `offset`).

##### Specifying the output location of piece data

Sometimes we may want to specify the output location of piece data, which can be specified using the -o flag
```sh
   --output value, -o value  output piece as a car file to the specific path
```

##### Directly restore piece data from unseal file

By default, Damocles restores piece data from sealed files, but if the user has kept `unseal files`, piece data can be directly restored from `unseal files`, which will save a lot of time and resources. In this case, the `--unseal-file` flag can be used to specify the path to the `unseal file` corresponding to the piece.
```sh
   --unseal-file value  unseal piece from unseal file
```

##### Upload files to target locations via dest protocol

By default, and with the `-o` flag, the piece data unsealed by the `Worker` will be uploaded to the `Manager`, and the `Manager` will output it to the specified path on the machine where the `Manager` is located. But sometimes, we don't want the `Worker to upload` piece data to the `Manager`, but directly upload it to other target locations. This is when the `--dest` flag needs to be used.

The dest protocol supports specifying the target location for uploading piece data in the following four ways:

- Output the file directly to the local `Worker`
  - [file:///path](/path)
  - Note that the host position in the above url must be empty.

- Network location
  - "http://" [https://](../NULL)

- Upload to `Droplet`'s `piece store`
  - "[market://store\_name/piece\_cid](market://store_name/piece_cid)"
  - Where `store_name` is the name of the piece store in the market

- Upload to `Manager`'s `piece store`:
  - "[store://store\_name/piece\_cid](store://store_name/piece_cid)"
  - Where `store_name` is the name of the `piece store` in the `Manager`
  - Note: Make sure the `Manager`'s `piece store` is already mounted and configured on the `Worker`

Since restoring piece data from `unseal files` does not need to go through the `Worker`, specifying the `--dest` flag is invalid in this case