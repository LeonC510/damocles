## Process of switching from lotus-miner to damocles

This section introduces the process of switching from `lotus-miner` to `damocles`. Typical scenarios for this demand are:

- `lotus-miner` has already sealed sectors;
- Requirements after switching to damocles:
  - Can continue sealing new sectors;
  - Proof of spacetime works normally (wdPoSt and winPoSt).

### Switching process
 Based on the above requirements, switching to `damocles` involves:

- Set up `venus` chain services, or [connect to existing chain services](https://sophon.venus-fil.io/zh/operation/join-a-cs.html), please refer to `venus` related docs, note wallet private key needs to be imported into `venus-wallet`;
- Initialize `damocles` repo, see [Quickstart](./05.quick-start.md) for details;
- Import sector permanent storage, see [06.Import existing sectors](06.导入已存在的扇区数据.md);
- Import sector metadata;
- Use `Damocles` to seal new sectors, please refer to [related docs](./03.damocles-worker-config.md).

Prerequisites:

- The sector sealing process of `damocles` and `lotus-miner` is incompatible. So when switching, it should be ensured that all sector sealing tasks are completed.(`Proving`)

#### Metadata import
 Importing sector metadata is done by calling respective interfaces, so the process requires both `lotus-miner` and `damocles-manager` services to be running.
```
./damocles-manager util sealer sectors import --api=<cat ~/.lotusminer/api> \
--token=<cat ~/.lotusminer/token>
```

Optional `flags`:

- `override`, `bool` type, indicates whether to override existing data, default is `false`;
- `numbers`, slice type, specifies sector numbers to import, for example to import metadata for sector numbers `200, 300`, use refer: `--numbers=200 --numbers=300`;

In `damocles`, use below command to query imported sector information:
```
./damocles-manager util sealer sectors list --offline=true
```


## process of switching from damocles to lotus-miner

This section introduces the process of switching from damocles to lotus-miner, typical scenarios are:

- Sectors have been sealed with damocles;
- Requirements after switching to lotus-miner:
  - Can continue sealing new sectors;
  - Proof of spacetime works normally (wdPoSt and winPoSt).

### Switching process

Based on the above requirements, switching to `lotus-miner` involves the following process:

- Set up `lotus` chain services, refer to [lotus official docs](https://lotus.filecoin.io/lotus/get-started/what-is-lotus/), note that wallet private keys used in `venus-wallet` need to be exported to `lotus`;
- Export sector persistent data, to ensure sectors sealed by `damocles` can be correctly read in `lotus-miner`, this is required for proof of spacetime;
- Export sector metadata, to support viewing historical sector info and rebuilding sectors in `lotus-miner`. **This step is required if needing to rebuild damaged sector files** ;
- Update `lotus-miner` database `/storage/nextid`, to avoid duplicate sector numbers when sealing new sectors.

Prerequisites:

- The sector sealing process of `damocles` and `lotus-miner` is incompatible. So when switching, it should be ensured that all sector sealing tasks ( **including redos** ) are completed, i.e. status `Finalized: true`, unfinished sectors will not be exported.
- lotus-miner does not provide API to import sector metadata, so directly writing data to database is used. `lotus-miner` process needs to be stopped before exporting data.

#### Export persistent data

`damocles` persistent storage directory allows managing sector files for multiple `miner`, while `lotus-miner`'s multiple persistent directories only manage one `miner` sector files.

> If `cluster` permanent storage manages multiple `miner` sector files, and needs rearchiving when exiting a `miner`, exporting via command is recommended, otherwise directly configuring `cluster`'s permanent storage for `lotus-miner` is ok, see below.

In `lotus-miner`, configure persistent storage via command:

```
./lotus-miner storage attach --init --store <store path>
```

View persistent storage:

```
./lotus-miner storage list
```
More on `lotus-miner` persistent storage see [lotus-miner storage config](https://lotus.filecoin.io/tutorials/lotus-miner/run-a-miner/#lotus-miner-configuration)

Export sector persistent data:

```
./damocles-manager util sealer sectors export --miner=<miner address> files \
--dest-path=<lotus store path>
```
Optional `flag`:

- `reserve`, `bool` type, whether to reserve persistent data in `damocles`, default `false;
- `numbers`, slice type, specifies sector numbers to export, if not set, exports all. For example to export persistent data for sectors `200, 300`, use refer as: `--numbers=200 --numbers=300`;

Command execution example:

- Adding `--reserve` flag means reserving source files, i.e. copying sector files. This is slower, ignores copy if target file exists, if not, just directly copy it. Using this method avoids possible `wdPoSt` failures during export.
```
> ./damocles-manager util sealer sectors export --miner=t04079 files --dest-path=/storage-nfs-4/dest/t04079 --numbers 160 --reserve
move sector 160 file...
copy file from /storage-nfs-4/src/t04079/update/s-t04079-160 to /storage-nfs-4/dest/t04079/update/s-t04079-160
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/p_aux to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/p_aux
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-0.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-0.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-1.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-1.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-2.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-2.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-3.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-3.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-4.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-4.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-5.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-5.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-6.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-6.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-7.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-7.dat
copy file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/t_aux to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/t_aux
export failure number: 0, total: 1
```

- Not adding the `--reserve` flag indicates not retaining the source files, i.e. moving the sector files. If the destination and source are in the same disk partition, this method is very fast, so it is recommended to use this method.
```
> ./damocles-manager util sealer sectors export --miner=t04079 files --dest-path=/storage-nfs-4/dest/t04079 --numbers 160
move sector 160 file...
move file from /storage-nfs-4/src/t04079/update/s-t04079-160 to /storage-nfs-4/dest/t04079/update/s-t04079-160
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/p_aux to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/p_aux
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-0.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-0.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-1.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-1.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-2.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-2.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-3.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-3.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-4.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-4.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-5.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-5.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-6.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-6.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-7.dat to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/sc-02-data-tree-r-last-7.dat
move file from /storage-nfs-4/src/t04079/update-cache/s-t04079-160/t_aux to /storage-nfs-4/dest/t04079/update-cache/s-t04079-160/t_aux
export failure number: 0, total: 1
```

:::tip

When do you need to migrate sector persistent files? When the persistent directories of `Damocles` and `lotus-miner` are inconsistent. In general, we do not recommend migrating sector files, because migration is time-consuming, and may cause `wdPoSt` failures during the process. A better approach is to also configure the `Damocles` persistent directory to the `lotus-miner` storage list.

Assuming the original `lotus-miner` `store` list has:
```
$ ./lotus-miner storage list
4e34aa51-e955-4542-bd3a-6da3befc15a4:
        [############                                      ] 54.58 TiB/217.4 TiB 25%
        Unsealed: 0; Sealed: 0; Caches: 0; Updated: 0; Update-caches: 0; Reserved: 0 B
        Weight: 10; Use: Store
        Local: /storage-nfs-4/thelt/t05114
        URL: http://127.0.0.1:2345/remote
```

After switching to `damocles`, add the following storage list for this miner:
```toml
[[Common.PersistStores]]
Name = "t05114_01"
Path = "/storage-nfs-4/t05114_01"

[[Common.PersistStores]]
Name = "t05114_02"
Path = "/storage-nfs-4/t05114_02"
```

We just need to `attach` these two directories to the `lotus-miner` storage list:
```
$ ./lotus-miner storage attach --store --init /storage-nfs-4/t05114_02
$ ./lotus-miner storage attach --store --init /storage-nfs-4/t05114_01
```
After adding, if they appearance in the list that indicates success.

:::

#### Exporting Metadata

Only modify `/storage/nextid`:
```
./damocles-manager util sealer sectors export --miner=<miner address> metadata \
--dest-repo=<lotus-miner repo> \
--next-number=<next number> \
--only-next-number=true 
```
> The `next-number` is required, and it is best to be the largest sector number among the sealed sectors. The sector number newly allocated by `lotus-miner` is the value set here +1.

> Use the absolute path for `dest-repo`, such as `/root/.lotusminer`.

> The modification of `/storage/nextid` needs to be completed before `lotus-miner` starts sealing new sectors. Once sealing starts with `lotus-miner`, this modification will be invalid, which is determined by the allocation mechanism of `lotus-miner` itself. See next-sid allocation in lotus-miner for details.

Export metadata and set new sector number:
```
./damocles-manager util sealer sectors export --miner=<miner address> metadata \
--dest-repo=<lotus-miner repo> \
--next-number=<next number>
```
> The next-number is optional. If not set, it is processed as the largest sealed sector number. When set, if the value is smaller than the largest sealed sector number, it is processed as the largest sealed sector number, otherwise it is processed as the set value.

Start `lotus-miner`, querying the sectors sealed by `damocles` through the following command indicates successful export. New sectors can then be sealed.
```
./lotus-miner sector list
```

View the new sector number:
```
./lotus-miner sectors numbers info
```

> There may be cases in `damocles` where sealed sectors are still `Finalized: false`. These need to be manually set to Completed state in order to be exported to `lotus-miner`.